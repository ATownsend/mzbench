<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Deployment - MZBench Docs</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">MZBench Docs</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Overview</a>
                    </li>
                
                
                
                    <li >
                        <a href="../scenarios/">Scenarios</a>
                    </li>
                
                
                
                    <li >
                        <a href="../server_api/">Server API</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Deployment</a>
                    </li>
                
                
                
                    <li >
                        <a href="../workers/">Workers</a>
                    </li>
                
                
                
                    <li >
                        <a href="../cloud_plugin/">Cloud Plugins</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../server_api/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../workers/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="http://github.com/machinezone/mzbench/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#introduction">Introduction</a></li>
        
    
        <li class="main "><a href="#mzbench-architecture">MZBench architecture</a></li>
        
    
        <li class="main "><a href="#server-installation">Server installation</a></li>
        
            <li><a href="#requirements">Requirements</a></li>
        
            <li><a href="#server-installation_1">Server installation</a></li>
        
    
        <li class="main "><a href="#server-configuration">Server configuration</a></li>
        
            <li><a href="#configuration-file-format">Configuration file format</a></li>
        
            <li><a href="#server-parameters-mzbench_api">Server parameters (mzbench_api)</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>This document explains how to deploy and configure an MZBench API server on your own infrastructure.
The scope includes installation and configuration of the API server. Installation
and configuration of the Graphite host is not covered. The Graphite host is
 optional, although you will certainly need it for any serious use.</p>
<h1 id="mzbench-architecture">MZBench architecture<a class="headerlink" href="#mzbench-architecture" title="Permanent link">&para;</a></h1>
<p>In its more general form, a complete MZBench installation consists of several separate hosts:</p>
<ul>
<li>An MZBench API server that accepts the client requests and provides the dashboard</li>
<li>A metric gathering host, usually Graphite, providing the graph plotting services</li>
<li>A set of hosts to use as a worker nodes</li>
</ul>
<p>The API server and Graphite hosts are permanent, while the worker nodes can be dynamically
allocated when needed, for example on Amazon.</p>
<h1 id="server-installation">Server installation<a class="headerlink" href="#server-installation" title="Permanent link">&para;</a></h1>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<p>To run an MZBench API server, you need to install the following packages:</p>
<ul>
<li>A C++ compiler</li>
<li>Erlang R17 distribution (http://www.erlang.org)</li>
<li>Python v2.6 (https://www.python.org)</li>
<li>PIP Python package manager (https://pip.pypa.io/en/stable/)</li>
</ul>
<h2 id="server-installation_1">Server installation<a class="headerlink" href="#server-installation_1" title="Permanent link">&para;</a></h2>
<p>To install the MZBench API server, perform the following commands:</p>
<pre><code># Clone the current MZBench source code
git clone https://github.com/machinezone/mzbench.git

# Install additional Python packages
sudo pip install -r mzbench/requirements.txt

# Start the server
./mzbench/bin/mzbench start_server

# Stop the server
./mzbench/bin/mzbench stop_server
</code></pre>
<h1 id="server-configuration">Server configuration<a class="headerlink" href="#server-configuration" title="Permanent link">&para;</a></h1>
<p>To apply configuration changes you need to restart the server if it&rsquo;s running.</p>
<h2 id="configuration-file-format">Configuration file format<a class="headerlink" href="#configuration-file-format" title="Permanent link">&para;</a></h2>
<p>The MZBench server parameters are set in configuration file.
It can be passed as an argument to bin/mzbench start_server command.</p>
<p>For example: bin/mzbench start_server &ndash;config ./server.config</p>
<p>By default, the server tries to load configuration from the following places:</p>
<p>~/.config/mzbench/server.config
/etc/mzbench/server.config</p>
<p>The configuraion file is essentially an Erlang term. At the top level, it is a list of tuples, terminated by the dot.
 Each tuple represent a configuration category. Its first element is an atom identifying the
 category, its second element is a list of actual parameters. Each of parameters is a tuple
  by itself, containing the parameter name and the value.</p>
<p>For the sake of clarity, let&rsquo;s see the following example configuration:</p>
<pre><code>[
    {mzbench_api, [
        {graphite, "172.21.8.192"},
        {listen_port, 80}
    ]}
].
</code></pre>
<p>It contains only one category: <code>mzbench_api</code>. This category is used for the parameters of the server itself.</p>
<p>Here, we specify two parameters: <code>graphite</code> and <code>listen_port</code>. <code>graphite</code> specifies the IP
 address of the host containing the Graphite server to use (here <code>172.21.8.192</code>). <code>listen_port</code>
 specifies which port should be used to access the server dashboard (here <code>80</code>).</p>
<h2 id="server-parameters-mzbench_api">Server parameters (<code>mzbench_api</code>)<a class="headerlink" href="#server-parameters-mzbench_api" title="Permanent link">&para;</a></h2>
<p>These parameters are going to the <code>mzbench_api</code> category.</p>
<h3 id="cloud_plugins-name-atom-opts"><code>{cloud_plugins, [{Name :: atom(), Opts :: #{}}]}</code><a class="headerlink" href="#cloud_plugins-name-atom-opts" title="Permanent link">&para;</a></h3>
<p>Plugins responsible for node allocation, [{dummy, #{module =&gt; mzb_dummycloud_plugin}}] by default.
Name represents the name of the particular instance of plugin and could be any atom.
Opts must contain either module or application key, other keys in Opts depend on particular plugin type.
It is possible to specify several plugins. The actually used plugin can be specified with &ndash;cloud option of the bin/mzbench utility.
There are three cloud plugins available in mzbench so far. See below for configuration details and a few examples.
See also: <a href="doc/cloud_plugin.md">Cloud plugin creation guide</a></p>
<h4 id="configuration-of-the-aws-ec2-cloud-plugin">Configuration of the AWS EC2 cloud plugin<a class="headerlink" href="#configuration-of-the-aws-ec2-cloud-plugin" title="Permanent link">&para;</a></h4>
<p>mzb_api_ec2_plugin module allocates hosts in EC2 and requires &lsquo;instance_spec&rsquo; and &lsquo;config&rsquo; keys to be specified in Opts (see above).
For AWS specific configuration details, see <a href="https://github.com/gleber/erlcloud">erlcloud documentation</a>.
AWS image tips: an image should contain Erlang R17, gcc, gcc-c++, git, sudo.
sudo shoud be available for non-tty execution (put &ldquo;Defaults !requiretty&rdquo; to /etc/sudoers).
It is also required to have ssh and tcp 4801/4802 ports connectivity between server and nodes for
logs and metrics. Please refer EC2 documentation on image publish process, it can be done from
web AWS console within few clicks. We prepared such image with Amazon Linux (ami-3b90a80b), but you
may require some additional software. For this image you need to register and specify your keypair name
with your AWS credentials.</p>
<p>Configuration example:</p>
<pre><code>{cloud_plugins, [{ec2, #{module =&gt; mzb_api_ec2_plugin,
                         instance_spec =&gt; [
                          {image_id, "ami-2c03b22c"},
                          {group_set, ""},
                          {key_name, "-"},
                          {subnet_id, "-"},
                          {instance_type, "t2.micro"},
                          {availability_zone, "us-west-2a"}
                        ],
                        config =&gt; [
                          {ec2_host, "ec2.us-west-2.amazonaws.com"},
                          {access_key_id, "-"},
                          {secret_access_key, "-"}
                         ]
                        instance_user =&gt; "ec2-user",
                    }}]},
</code></pre>
<h4 id="configuration-of-static-cloud-plugin">Configuration of static cloud plugin<a class="headerlink" href="#configuration-of-static-cloud-plugin" title="Permanent link">&para;</a></h4>
<p>mzb_staticcloud_plugin does not allocate any hosts, the specified list of hosts is used instead.</p>
<p>Configuration example:</p>
<pre><code>{cloud_plugins, [{static, #{module =&gt; mzb_staticcloud_plugin,
                           hosts =&gt; ["host1", "host2"]
                           }}]}
</code></pre>
<h4 id="configuration-of-dummy-cloud-plugin">Configuration of dummy cloud plugin<a class="headerlink" href="#configuration-of-dummy-cloud-plugin" title="Permanent link">&para;</a></h4>
<p>mzb_dummycloud_plugin does not allocate any hosts, localhost is used instead.</p>
<p>Configuration example:</p>
<pre><code>{cloud_plugins, [{dummy, #{module =&gt; mzb_dummycloud_plugin}}]}
</code></pre>
<h3 id="bench_data_dir-path"><code>{bench_data_dir, "&lt;path&gt;"}</code><a class="headerlink" href="#bench_data_dir-path" title="Permanent link">&para;</a></h3>
<p>This parameter specifies where to store the various benchmark generated data.</p>
<p>By default <code>mzbench_api_data</code> in the home directory of the user who started the server.</p>
<h3 id="graphite-hostname-or-ip"><code>{graphite, "&lt;hostname or ip&gt;"}</code><a class="headerlink" href="#graphite-hostname-or-ip" title="Permanent link">&para;</a></h3>
<p>This parameter specifies where to send the metrics, the host or IP address of the Graphite server.</p>
<h3 id="graphite_api_key-string"><code>{graphite_api_key, "&lt;string&gt;"}</code><a class="headerlink" href="#graphite_api_key-string" title="Permanent link">&para;</a></h3>
<p>Hostedgraphite.com API key.</p>
<h3 id="graphite_url-url"><code>{graphite_url, "&lt;URL&gt;"}</code><a class="headerlink" href="#graphite_url-url" title="Permanent link">&para;</a></h3>
<p>Hostedgraphite.com URL, usually something like this: https://www.hostedgraphite.com/xxxxxxxx/graphite/</p>
<p>By default, no metrics will be sent.</p>
<h3 id="listen_port-port"><code>{listen_port, &lt;port&gt;}</code><a class="headerlink" href="#listen_port-port" title="Permanent link">&para;</a></h3>
<p>This parameter is used to specify the port used to access the server dashboard.</p>
<p>By default, the dashboard listens on <code>4800</code>.</p>
<h3 id="network_interface-ip-address"><code>{network_interface, "&lt;ip address&gt;"}</code><a class="headerlink" href="#network_interface-ip-address" title="Permanent link">&para;</a></h3>
<p>This parameter is used to specify the interface for dashboard to listen (by default it is &ldquo;127.0.0.1&rdquo;),
so the dashboard won&rsquo;t be available for any external connections. To open dashboard
 for everyone, specify &ldquo;0.0.0.0&rdquo;
 <em>Warning:</em> mzbench doesn&rsquo;t provide any authentication and opening it
to everyone would bring additional vulnerability to your server, mzbench dashboard should be protected with an external auth proxy like nginx.</p>
<h3 id="node_git-url"><code>{node_git, "&lt;url&gt;"}</code><a class="headerlink" href="#node_git-url" title="Permanent link">&para;</a></h3>
<p>Specifies the MZBench Git repository used to deploy the worker nodes.</p>
<p>By default, the MZBench source code will be taken from <code>https://github.com/machinezone/mzbench.git</code>.</p>
<h3 id="node_commit-string"><code>{node_commit, "&lt;string&gt;"}</code><a class="headerlink" href="#node_commit-string" title="Permanent link">&para;</a></h3>
<p>Specifies Git commit SHA or Git branch name used to deploy the worker nodes.</p>
<h3 id="ntp_max_timediff-float"><code>{ntp_max_timediff, &lt;float&gt;}</code><a class="headerlink" href="#ntp_max_timediff-float" title="Permanent link">&para;</a></h3>
<p>Maximum distance between node timers (default is 0.1), this check is optional and would only print a warning if failed.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
